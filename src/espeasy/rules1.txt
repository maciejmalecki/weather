on System#Boot do
  AsyncEvent,evtStart
endon

on System#Wake do
  AsyncEvent,evtStart
endon

on MQTT#Connected do
  Let,2,%unixday_sec%-%v1%
  AsyncEvent,evtPublish
endon

on MQTT#Disconnected do
  AsyncEvent,evtNext
endon

on evtStart do
  Let,1,%unixday_sec%
  if [Plugin#GPIO#Pinstate#14]=1
    TimerSet,2,1
  else
    TaskValueSet,3,1,0
  endif
  TimerSet,3,30
endon

on evtPublish do
  Publish,%sysname%_%unit%/temp,[weather#temp]
  Publish,%sysname%_%unit%/hum,[weather#hum]
  Publish,%sysname%_%unit%/vcc,[vcc#vcc]
  Publish,%sysname%_%unit%/status,[dummy#mode]
  Let,3,%unixday_sec%-%v1%
  Publish,%sysname%_%unit%/time0,%v2%
  Publish,%sysname%_%unit%/time1,%v3%
  AsyncEvent,evtNext
endon

on evtNext do
  if [dummy#mode]=0
    DeepSleep,900
  else
    TimerSet,1,60
  endif
endon

on Rules#Timer=1 do
  AsyncEvent,evtPublish
endon

on Rules#Timer=2 do
  TaskValueSet,3,1,[Plugin#GPIO#Pinstate#14]
endon

on Rules#Timer=3 do
  AsyncEvent,evtNext
endon